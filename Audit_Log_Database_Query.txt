-- AEGIS MASTER SCHEMA v4.5

-- 1. Users & Clients Table
CREATE TABLE users (
    user_id SERIAL PRIMARY KEY,
    email TEXT UNIQUE NOT NULL,
    password_hash TEXT NOT NULL,
    organization_name TEXT NOT NULL,
    role TEXT DEFAULT 'CLIENT', -- 'CLIENT' or 'SUPER_ADMIN'
    created_at TIMESTAMP DEFAULT NOW()
);

-- 2. Multi-Tenant Audit Logs
CREATE TABLE audit_logs (
    log_id SERIAL PRIMARY KEY,
    user_id INT REFERENCES users(user_id) ON DELETE CASCADE,
    target_db TEXT NOT NULL,
    target_table TEXT NOT NULL,
    target_pk_id TEXT NOT NULL, -- Changed to TEXT to support UUIDs/Emails/Ints
    executed_at TIMESTAMP DEFAULT NOW(),
    status TEXT NOT NULL -- 'SUCCESS', 'FAILED'
);

-- 3. Initial Super Admin (Password: admin123)
-- Note: In production, change this immediately via the dashboard.
INSERT INTO users (email, password_hash, organization_name, role) 
VALUES ('admin@aegis.io', '$2b$12$3IEfsTOuI3RKo0NCfwrINOpuMTtbz8BSWjtObmEfqt4f0KSzyTVaS', 'AEGIS CORE', 'SUPER_ADMIN');

ALTER TABLE users ADD COLUMN accepted_terms BOOLEAN DEFAULT FALSE;
ALTER TABLE users ADD COLUMN terms_accepted_at TIMESTAMP;

select * from users;